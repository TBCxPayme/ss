<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî TBCxPayme CUP</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="admin-body">
  <div class="admin-container">
    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–º</h1>

    <div class="token-box">
      <label>üîë GitHub Token:</label>
      <input type="password" id="tokenInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω..." />
      <button id="saveTokenBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
    </div>

    <div class="comment-box">
      <label>üìù –†–µ–ø–∫–∞ / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é:</label>
      <input type="text" id="commitMsg" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã 2-–≥–æ —Ä–∞—É–Ω–¥–∞" />
    </div>

    <button id="saveBtn">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    <div id="status" class="status-box"></div>

    <div id="adminBracket"></div>
  </div>

  <script>
    const adminBracket = document.getElementById("adminBracket");
    const saveBtn = document.getElementById("saveBtn");
    const statusBox = document.getElementById("status");
    const tokenInput = document.getElementById("tokenInput");
    const commitMsgInput = document.getElementById("commitMsg");
    const saveTokenBtn = document.getElementById("saveTokenBtn");

    let data;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      const res = await fetch("data.json");
      data = await res.json();
      renderAdmin(data.rounds);
    }

    function renderAdmin(rounds) {
      adminBracket.innerHTML = "";
      rounds.forEach((round, rIndex) => {
        const roundDiv = document.createElement("div");
        roundDiv.classList.add("round");
        const title = document.createElement("h3");
        title.textContent = round.name;
        roundDiv.appendChild(title);

        round.matches.forEach((match, mIndex) => {
          const matchDiv = document.createElement("div");
          matchDiv.classList.add("match");
          matchDiv.innerHTML = `
            <input class="team-input" value="${match.teamA}">
            <input class="score-input" type="number" value="${match.scoreA}">
            <span>vs</span>
            <input class="team-input" value="${match.teamB}">
            <input class="score-input" type="number" value="${match.scoreB}">
          `;

          const inputs = matchDiv.querySelectorAll("input");
          inputs.forEach((inp, i) => {
            inp.addEventListener("change", () => {
              if (i === 0) match.teamA = inp.value;
              if (i === 1) match.scoreA = parseInt(inp.value);
              if (i === 2) match.teamB = inp.value;
              if (i === 3) match.scoreB = parseInt(inp.value);
            });
          });

          roundDiv.appendChild(matchDiv);
        });

        adminBracket.appendChild(roundDiv);
      });
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    saveTokenBtn.addEventListener("click", () => {
      const token = tokenInput.value.trim();
      if (token) {
        sessionStorage.setItem("githubToken", token);
        showStatus("‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ (–≤ —Å–µ—Å—Å–∏–∏)", "success");
      } else {
        showStatus("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º", "error");
      }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    saveBtn.addEventListener("click", async () => {
      const token = sessionStorage.getItem("githubToken");
      const commitMsg = commitMsgInput.value.trim() || "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞";

      if (!token) {
        showStatus("‚ö†Ô∏è –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ!", "error");
        return;
      }

      showStatus("‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...", "loading");

      const username = "TBCxPayme";
      const repo = "CyberSport";
      const path = "data.json";
      const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
      const content = btoa(JSON.stringify(data, null, 2));

      try {
        const res = await fetch(url);
        const file = await res.json();

        const update = await fetch(url, {
          method: "PUT",
          headers: {
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: commitMsg,
            content: content,
            sha: file.sha
          })
        });

        if (update.ok) {
          showStatus("‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ GitHub!", "success");
        } else {
          showStatus("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏! –ü—Ä–æ–≤–µ—Ä—å —Ç–æ–∫–µ–Ω –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.", "error");
        }
      } catch (e) {
        showStatus("üö® –°–±–æ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
      }
    });

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    function showStatus(msg, type) {
      statusBox.textContent = msg;
      statusBox.className = "status-box " + type;
    }

    loadData();
  </script>
</body>
</html>
